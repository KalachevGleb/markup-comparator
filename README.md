# Инструмент для сравнения разметки трудных жизненных ситуаций

## Описание

Данный инструмент предназначен для сравнения разметки текстовых ситуаций с эталонной разметкой. Программа анализирует, насколько точно тестируемая разметка соответствует эталону, и формирует подробный отчет с различными метриками качества разметки.

Программа поддерживает различные способы нормализации статистики (по эталону, по тестируемой разметке или по общему количеству случаев) и рассчитывает интегральную метрику эффективности разметки с настраиваемыми весами для разных типов ошибок.

## Назначение

Инструмент полезен для:

* Проверки качества разметки текстов
* Обучения новых специалистов по разметке
* Оценки согласованности разметки между разными экспертами
* Выявления типичных ошибок разметки

## Системные требования

* Python 3.8 или выше

## Установка

```bash
git clone https://github.com/KalachevGleb/markup-comparator.git
cd markup-comparator
```

## Использование

### Основной способ запуска

```bash
python compare_reports.py путь_к_тестируемой_разметке.txt -r путь_к_эталонной_разметке.txt
```

Программа создаст HTML-отчет `report.html` в текущей директории.

### Параметры командной строки

| Параметр | Сокращение | Описание | Значение по умолчанию |
|----------|------------|----------|------------------------|
| `filename` |  | Путь к файлу с тестируемой разметкой | Обязательный параметр |
| `--reference` | `-r` | Путь к файлу с эталонной разметкой | `reference.txt` |
| `--output` | `-o` | Путь для сохранения HTML-отчета | `report.html` |
| `--text-only` | | Вывести только текстовый отчет без генерации HTML | Выкл |
| `--both` | | Вывести текстовый отчет и сгенерировать HTML | Выкл |
| `--efficiency-config` | | Путь к файлу с конфигурацией эффективности (JSON) | `efficiency_config.json` |
| `--normalize` | | Способ нормализации статистики: `total`, `ref`, `test` | `ref` |
| `--ignore-errors` | | Не выводить ошибки сопоставления текстов между эталоном и тестируемой разметкой | Выкл |
| `--fix-codes` | | Добавлять пропущенные `*` перед кодами в тестируемой разметке | Выкл |
| `--json-only` | | Вывести только JSON-отчет и не генерировать HTML/текст | Выкл |
| `--json-output` | | Путь для сохранения JSON-отчета | `report.json` |
| `--help` | `-h` | Показать справку по параметрам | |

#### Опции нормализации (--normalize)

* **`total`** - нормализация по общему количеству всех случаев (случаи в эталоне + лишние случаи)
* **`ref`** - нормализация по количеству случаев в эталонной разметке (по умолчанию)
* **`test`** - нормализация по количеству случаев в тестируемой разметке

### Примеры запуска

```bash
# Базовый запуск
python compare_reports.py тест.txt -r эталон.txt

# Явное указание имени выходного файла
python compare_reports.py тест.txt -r эталон.txt -o результат.html

# Только текстовый отчет в консоль
python compare_reports.py тест.txt --text-only

# И текстовый, и HTML-отчеты
python compare_reports.py тест.txt --both

# Использование собственной конфигурации эффективности
python compare_reports.py тест.txt -r эталон.txt --efficiency-config моя_конфигурация.json

# Нормализация статистики по общему количеству случаев
python compare_reports.py тест.txt -r эталон.txt --normalize total

# Нормализация по тестируемой разметке
python compare_reports.py тест.txt -r эталон.txt --normalize test

# Отключение вывода ошибок сопоставления текстов
python compare_reports.py тест.txt -r эталон.txt --ignore-errors
```

## Формат входных файлов

Файлы разметки должны содержать одну или несколько ситуаций. Каждая ситуация должна иметь следующую структуру:

```txt
# Название ситуации
<Размеченное описание ситуации>
1. Как Вы её воспринимаете, оцениваете, переживаете и преодолеваете (какие действия помогают вам преодолеть ситуацию или свое состояние);
<Размеченный текст ответа на вопрос>
2. Каковы Ваши цели в этой ситуации?
<Размеченный текст ответа на вопрос>
3. Какие возможности и ограничения есть у Вас при достижении цели?
<Размеченный текст ответа на вопрос>
4. Нужна ли Вам в этой ситуации помощь (поддержка) окружающих людей?
<Размеченный текст ответа на вопрос>
5. Если всё сложится очень плохо, то что это будет? (максимальный неуспех)
<Размеченный текст ответа на вопрос>
6. Опишите, что для Вас будет максимально успешным выходом, разрешением ситуации.
<Размеченный текст ответа на вопрос>
```

Особенности формата:

* Каждая ситуация начинается с заголовка, начинающегося с символа `#`
* Формулировки вопросов должны быть в точности такие, как в описанном формате, без каких-либо изменений, поскольку по ним выполняется сопоставление.
* Размеченный текст представляет собой последовательность блоков
* Блок разметки представлен как текст в квадратных скобках, за которым следуют коды с префиксом `*`
* Коды разделяются запятыми
* В конце разметки может идти несколько кодов вне блоков.
* Для сравнения ситуации с эталоном необходимо, чтобы названия ситуаций в обоих файлах совпадали

## Метрики сравнения

Программа оценивает качество разметки по следующим метрикам:

### Верные коды (Correct)

Коды, которые присутствуют в тестируемой разметке на тех же позициях и с тем же текстом, что и в эталонной. **Выделяются зеленым цветом**.

### Пропущенные коды (Missing)

Коды, которые присутствуют в эталонной разметке, но отсутствуют в тестируемой на соответствующих позициях. **Выделяются бирюзовым цветом**.

### Лишние коды (Extra)

Коды, которые присутствуют в тестируемой разметке, но отсутствуют в эталонной на соответствующих позициях. **Выделяются красным цветом**.

### Смещенные коды (Misplaced)

Коды, которые присутствуют в обеих разметках, но на разных позициях или с разным выделенным текстом. **Найденные выделяются желтым цветом**, а **ожидаемые — розовым**.

### Дубликаты (Duplicates)

Коды, которые встречаются в тестируемой разметке на одной позиции более одного раза. **Выделяются оранжевым цветом**.

## Виды статистики в отчете

Программа предоставляет три разных способа анализа ошибок:

### Случаи

Случаем называется отнесение одного кода к какому-то классу (верные, пропущенные, лишние, смещённые, дубликаты) в контексте одного фрагмента текста. Например, несколько дубликатов одного и того же кода в одном блоке текста -- это один случай.
Если дубликаты одного и того же кода встречаются в ответах на разные вопросы, то это уже разные случаи.

### Вхождения

Общее количество кодов определенного типа. Например, сколько всего пропущенных кодов в разметке, причём если один и тот же код пропущен несколько раз, то это несколько вхождений. Таким образом, вхождения -- это случаи с учётом кратности.

### Взвешенные вхождения

Эта метрика выравнивает вклад кодов, которые встречаются разное количество раз. Здесь вес случая равен количеству вхождений этого случая, делённому на общее количество вхождений этого кода во все случаи.
Например, если код *A1 входит в эталонную разметку 1 раза, а в тестовую 4 раза, из них одно вхождение совпало с эталонным, то это будет оценено как 0.25 верного кода и 0.75 лишнего кода. То есть, для одного кода сумма всех взвешенных случаев равна 1, а вес пропорционален числу вхождений данного случая.

## Эффективность разметки

Программа рассчитывает интегральную метрику эффективности разметки, которая учитывает "стоимость" различных типов ошибок. Эффективность рассчитывается по формуле:

> Эффективность = 1 - (Общая стоимость ошибок / Количество кодов в эталоне)

### Конфигурация стоимости ошибок

Стоимость каждого типа ошибки настраивается через JSON-файл (по умолчанию `efficiency_config.json`):

```yaml
{
    "correct": 0.0,     # Сложность проверки верных кодов
    "misplaced": 0.2,   # Сложность исправления смещенных кодов
    "duplicates": 0.2,  # Сложность обнаружения дубликатов
    "extra": 0.5,       # Сложность проверки и обнаружения лишних кодов
    "missing": 1.0      # Сложность обнаруждения и добавления пропущенных кодов (равноценно разметке с нуля, поэтому коэффициент 1.0)
}
```

Значения представляют относительную "стоимость" каждого типа ошибки. Можно создать собственный файл конфигурации и указать его через параметр `--efficiency-config`.

## Структура HTML-отчета

HTML-отчет содержит:

1. **Боковая панель навигации** с оглавлением для быстрого перехода к отдельным ситуациям
2. **Сводная статистика** по всем ситуациям с возможностью переключения между типами статистики (случаи, вхождения, взвешенные вхождения)
3. **Метрика эффективности разметки** с указанием общей стоимости ошибок
4. **Сравнительная таблица** всех ситуаций с процентным соотношением случаев каждого типа и эффективностью для каждой ситуации
5. **Детальный анализ** каждой ситуации с цветовой разметкой ошибок

## Решение проблем

| Проблема | Решение |
|----------|---------|
| Ошибка "Файл не найден" | Убедитесь, что указанные пути к файлам корректны и доступны для чтения |
| Ошибка "Нет ситуаций для анализа" | Проверьте, что в тестируемой и эталонной разметке есть ситуации с одинаковыми названиями |
| Ошибка разбора файла | Проверьте формат разметки: названия ситуаций, формат разметки кодов |
| Места кодов в отчёте не соответствуют файлм с разметкой | Проверьте, что размечаемый текст в эталонной разметке и тестовой разметке совпадает |

## Обнаружение ошибок сопоставления текстов

Программа автоматически проверяет соответствие текстов между эталонной и тестируемой разметкой. При обнаружении значительных расхождений в тексте (схожесть менее 80%) программа выводит предупреждения в следующем формате:

```text
ОШИБКА СОПОСТАВЛЕНИЯ: Ситуация 'Название ситуации', Вопрос 2. Различие: 1.2%
  Эталон: '...Текст из эталонной разметки...'
  Тест:   '...Текст из тестируемой разметки...'
```

Эти предупреждения помогают выявить случаи, когда:

* Тексты в эталоне и тестируемой разметке не совпадают
* Произошла ошибка при подготовке файлов  
* Размеченные тексты относятся к разным ситуациям

### Отключение проверки сопоставления

Чтобы отключить вывод ошибок сопоставления текстов, используйте параметр `--ignore-errors`.
